import sqlite3
from typing import Optional, List, Dict, Any
import os
import json

class DatabaseAdapter:
    def __init__(self):
        self.cve_db_path = "/workspace/vulnerability-detection-tool/cve_database.db"
        self.db_path = "/workspace/vulnerability-detection-tool/foss_cherub.db"
        self._init_sqlite()
    
    def _init_sqlite(self):
        """Initialize SQLite database"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS scans (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                scan_id TEXT UNIQUE NOT NULL,
                repo_url TEXT,
                scan_name TEXT,
                status TEXT DEFAULT 'running',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP,
                findings_count INTEGER DEFAULT 0
            );
        """)
        
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS findings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                scan_id TEXT,
                file_path TEXT,
                line_number INTEGER,
                severity TEXT,
                cwe_id TEXT,
                description TEXT,
                code_snippet TEXT,
                ai_mitigation TEXT,
                corrected_code TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (scan_id) REFERENCES scans(scan_id)
            );
        """)
        
        # Add new columns if they don't exist
        new_columns = [
            "ai_mitigation TEXT",
            "corrected_code TEXT",
            "code_quality_improvements TEXT",
            "safer_coding_alternatives TEXT",
            "ast_structure_analysis TEXT",
            "security_best_practices TEXT",
            "performance_impact TEXT",
            "vulnerability_patterns TEXT",
            "remediation_priority TEXT",
            "code_complexity_metrics TEXT",
            "compliance_violations TEXT",
            "business_impact TEXT"
        ]
        
        for column in new_columns:
            try:
                cursor.execute(f"ALTER TABLE findings ADD COLUMN {column}")
            except sqlite3.OperationalError:
                pass
        
        conn.commit()
        conn.close()
    
    def get_connection(self):
        """Get database connection"""
        return sqlite3.connect(self.db_path)
    
    def insert_scan(self, scan_id: str, repo_url: str, scan_name: str, status: str = 'running'):
        """Insert or update scan record"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT OR REPLACE INTO scans (scan_id, repo_url, scan_name, status)
            VALUES (?, ?, ?, ?)
        """, (scan_id, repo_url, scan_name, status))
        
        conn.commit()
        cursor.close()
        conn.close()
    
    def insert_finding(self, scan_id: str, file_path: str, line_number: int, 
                      severity: str, cwe_id: str, description: str, code_snippet: str,
                      ai_mitigation: str = "", corrected_code: str = "",
                      code_quality_improvements: str = "", safer_coding_alternatives: str = "",
                      ast_structure_analysis: str = "", security_best_practices: str = "",
                      performance_impact: str = "", vulnerability_patterns: str = "",
                      remediation_priority: str = "medium", code_complexity_metrics: str = "",
                      compliance_violations: str = "", business_impact: str = ""):
        """Insert finding record with enhanced fields"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT INTO findings (
                scan_id, file_path, line_number, severity, cwe_id, description, code_snippet, 
                ai_mitigation, corrected_code, code_quality_improvements, safer_coding_alternatives,
                ast_structure_analysis, security_best_practices, performance_impact, 
                vulnerability_patterns, remediation_priority, code_complexity_metrics,
                compliance_violations, business_impact
            )
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (scan_id, file_path, line_number, severity, cwe_id, description, code_snippet, 
              ai_mitigation, corrected_code, code_quality_improvements, safer_coding_alternatives,
              ast_structure_analysis, security_best_practices, performance_impact,
              vulnerability_patterns, remediation_priority, code_complexity_metrics,
              compliance_violations, business_impact))
        
        conn.commit()
        cursor.close()
        conn.close()
    
    def get_scan(self, scan_id: str) -> Optional[Dict[str, Any]]:
        """Get scan with findings count"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT s.scan_id, s.repo_url, s.scan_name, s.status, s.created_at, COUNT(f.id) as findings_count
            FROM scans s
            LEFT JOIN findings f ON s.scan_id = f.scan_id
            WHERE s.scan_id = ?
            GROUP BY s.scan_id, s.repo_url, s.scan_name, s.status, s.created_at
        """, (scan_id,))
        
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        
        if result:
            return {
                'scan_id': result[0],
                'repo_url': result[1],
                'scan_name': result[2],
                'status': result[3],
                'created_at': result[4],
                'findings_count': result[5]
            }
        return None
    
    def get_findings(self, scan_id: str) -> List[Dict[str, Any]]:
        """Get all findings for a scan with enhanced fields"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT file_path, line_number, severity, cwe_id, description, code_snippet, 
                   ai_mitigation, corrected_code, code_quality_improvements, safer_coding_alternatives,
                   ast_structure_analysis, security_best_practices, performance_impact,
                   vulnerability_patterns, remediation_priority, code_complexity_metrics,
                   compliance_violations, business_impact
            FROM findings
            WHERE scan_id = ?
        """, (scan_id,))
        
        results = cursor.fetchall()
        cursor.close()
        conn.close()
        
        findings = []
        for row in results:
            finding = {
                'file_path': row[0],
                'line_number': row[1],
                'severity': row[2],
                'cwe_id': row[3],
                'description': row[4],
                'code_snippet': row[5],
                'ai_mitigation': row[6] if len(row) > 6 else "",
                'corrected_code': row[7] if len(row) > 7 else "",
                'code_quality_improvements': row[8] if len(row) > 8 else "",
                'safer_coding_alternatives': row[9] if len(row) > 9 else "",
                'ast_structure_analysis': row[10] if len(row) > 10 else "",
                'security_best_practices': row[11] if len(row) > 11 else "",
                'performance_impact': row[12] if len(row) > 12 else "",
                'vulnerability_patterns': json.loads(row[13]) if len(row) > 13 and row[13] else [],
                'remediation_priority': row[14] if len(row) > 14 else "medium",
                'code_complexity_metrics': json.loads(row[15]) if len(row) > 15 and row[15] else {},
                'compliance_violations': json.loads(row[16]) if len(row) > 16 and row[16] else [],
                'business_impact': row[17] if len(row) > 17 else ""
            }
            findings.append(finding)
        
        return findings
    
    def update_scan_status(self, scan_id: str, status: str):
        """Update scan status"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute("UPDATE scans SET status = ? WHERE scan_id = ?", (status, scan_id))
        
        conn.commit()
        cursor.close()
        conn.close()
    
    def query_cve_by_cwe(self, cwe_id: str, limit: int = 10) -> List[Dict[str, Any]]:
        """Query CVEs by CWE ID"""
        try:
            conn = sqlite3.connect(self.cve_db_path)
            cursor = conn.cursor()
            
            cursor.execute("""
                SELECT id, description, cvss_v3_score, cvss_v3_severity, cwe_ids, published_date
                FROM cves 
                WHERE cwe_ids LIKE ?
                ORDER BY published_date DESC 
                LIMIT ?
            """, (f"%{cwe_id}%", limit))
            
            results = cursor.fetchall()
            conn.close()
            
            return [
                {
                    'cve_id': row[0],
                    'description': row[1],
                    'cvss_score': row[2],
                    'severity': row[3],
                    'cwe_ids': row[4],
                    'published_date': row[5]
                }
                for row in results
            ]
        except Exception as e:
            print(f"CVE query error: {e}")
            return []
    
    def get_cwe_info(self, cwe_id: str) -> Optional[Dict[str, Any]]:
        """Get CWE information"""
        try:
            conn = sqlite3.connect(self.cve_db_path)
            cursor = conn.cursor()
            
            cursor.execute("""
                SELECT id, name, description, weakness_type
                FROM cwes 
                WHERE id = ?
            """, (cwe_id,))
            
            result = cursor.fetchone()
            conn.close()
            
            if result:
                return {
                    'cwe_id': result[0],
                    'name': result[1],
                    'description': result[2],
                    'weakness_type': result[3]
                }
            return None
        except Exception as e:
            print(f"CWE query error: {e}")
            return None
    
    def enrich_finding_with_cve(self, finding: Dict[str, Any]) -> Dict[str, Any]:
        """Enrich finding with CVE data"""
        cwe_id = finding.get('cwe_id', '')
        if cwe_id:
            # Get related CVEs
            cves = self.query_cve_by_cwe(cwe_id, limit=3)
            finding['related_cves'] = cves
            
            # Get CWE info
            cwe_info = self.get_cwe_info(cwe_id)
            finding['cwe_info'] = cwe_info
        
        return finding