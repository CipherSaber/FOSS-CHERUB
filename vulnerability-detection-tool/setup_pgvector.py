#!/usr/bin/env python3
"""Setup script for pgvector integration"""
import psycopg2
from psycopg2.extras import RealDictCursor
import sys

def setup_pgvector():
    """Setup pgvector extension and update existing data"""
    config = {
        'host': 'localhost',
        'port': 5432,
        'database': 'foss_cherub',
        'user': 'postgres',
        'password': 'foss_cherub_2024'
    }
    
    try:
        conn = psycopg2.connect(**config)
        conn.autocommit = True
        
        with conn.cursor() as cursor:
            print("ğŸ”§ Setting up pgvector extension...")
            
            # Enable pgvector extension
            cursor.execute("CREATE EXTENSION IF NOT EXISTS vector;")
            print("âœ… pgvector extension enabled")
            
            # Check if vector columns exist
            cursor.execute("""
                SELECT column_name 
                FROM information_schema.columns 
                WHERE table_name = 'findings' 
                AND column_name IN ('description_embedding', 'code_embedding')
            """)
            existing_cols = [row[0] for row in cursor.fetchall()]
            
            # Add vector columns if they don't exist
            if 'description_embedding' not in existing_cols:
                cursor.execute("ALTER TABLE findings ADD COLUMN description_embedding vector(384);")
                print("âœ… Added description_embedding column")
            
            if 'code_embedding' not in existing_cols:
                cursor.execute("ALTER TABLE findings ADD COLUMN code_embedding vector(384);")
                print("âœ… Added code_embedding column")
            
            # Create vector indexes if they don't exist
            cursor.execute("""
                SELECT indexname FROM pg_indexes 
                WHERE tablename = 'findings' 
                AND indexname IN ('idx_findings_desc_embedding', 'idx_findings_code_embedding')
            """)
            existing_indexes = [row[0] for row in cursor.fetchall()]
            
            if 'idx_findings_desc_embedding' not in existing_indexes:
                cursor.execute("""
                    CREATE INDEX idx_findings_desc_embedding 
                    ON findings USING ivfflat (description_embedding vector_cosine_ops) 
                    WITH (lists = 100);
                """)
                print("âœ… Created description embedding index")
            
            if 'idx_findings_code_embedding' not in existing_indexes:
                cursor.execute("""
                    CREATE INDEX idx_findings_code_embedding 
                    ON findings USING ivfflat (code_embedding vector_cosine_ops) 
                    WITH (lists = 100);
                """)
                print("âœ… Created code embedding index")
            
            # Check if we need to populate embeddings for existing data
            cursor.execute("SELECT COUNT(*) FROM findings WHERE description_embedding IS NULL")
            null_count = cursor.fetchone()[0]
            
            if null_count > 0:
                print(f"ğŸ“Š Found {null_count} findings without embeddings")
                print("ğŸ’¡ Run populate_embeddings.py to generate embeddings for existing data")
            else:
                print("âœ… All findings have embeddings")
        
        conn.close()
        print("\nğŸ‰ pgvector setup completed successfully!")
        
    except Exception as e:
        print(f"âŒ Setup failed: {e}")
        sys.exit(1)

if __name__ == "__main__":
    setup_pgvector()