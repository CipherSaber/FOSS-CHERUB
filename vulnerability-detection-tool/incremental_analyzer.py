import hashlib
import json
import os
from pathlib import Path
from typing import Dict, List, Set, Optional
import git

class IncrementalAnalyzer:
    def __init__(self, cache_dir: str = "/workspace/vulnerability-detection-tool/.incremental"):
        self.cache_dir = Path(cache_dir)
        self.cache_dir.mkdir(exist_ok=True)
        self.hash_file = self.cache_dir / "file_hashes.json"
        self.supported_extensions = {'.py', '.js', '.java', '.c', '.cpp', '.php', '.go', '.rb', '.rs'}
    
    def _get_file_hash(self, file_path: Path) -> str:
        """Get SHA256 hash of file content"""
        try:
            with open(file_path, 'rb') as f:
                return hashlib.sha256(f.read()).hexdigest()
        except:
            return ""
    
    def _load_hashes(self) -> Dict[str, str]:
        """Load previous file hashes"""
        if not self.hash_file.exists():
            return {}
        try:
            with open(self.hash_file, 'r') as f:
                return json.load(f)
        except:
            return {}
    
    def _save_hashes(self, hashes: Dict[str, str]) -> None:
        """Save current file hashes"""
        try:
            with open(self.hash_file, 'w') as f:
                json.dump(hashes, f)
        except:
            pass
    
    def get_changed_files(self, repo_path: str) -> List[str]:
        """Get list of changed files since last scan"""
        repo_path = Path(repo_path)
        old_hashes = self._load_hashes()
        new_hashes = {}
        changed_files = []
        
        # Scan all supported files
        for ext in self.supported_extensions:
            for file_path in repo_path.rglob(f"*{ext}"):
                if file_path.is_file():
                    rel_path = str(file_path.relative_to(repo_path))
                    new_hash = self._get_file_hash(file_path)
                    new_hashes[rel_path] = new_hash
                    
                    # Check if file changed
                    if rel_path not in old_hashes or old_hashes[rel_path] != new_hash:
                        changed_files.append(str(file_path))
        
        # Save new hashes
        self._save_hashes(new_hashes)
        return changed_files
    
    def get_git_changed_files(self, repo_path: str, since_commit: Optional[str] = None) -> List[str]:
        """Get changed files using git diff"""
        try:
            repo = git.Repo(repo_path)
            if since_commit:
                diff = repo.git.diff(since_commit, '--name-only').split('\n')
            else:
                # Get uncommitted changes
                diff = repo.git.diff('HEAD', '--name-only').split('\n')
                diff += repo.git.diff('--cached', '--name-only').split('\n')
            
            changed_files = []
            for file_path in diff:
                if file_path and Path(file_path).suffix in self.supported_extensions:
                    full_path = Path(repo_path) / file_path
                    if full_path.exists():
                        changed_files.append(str(full_path))
            
            return list(set(changed_files))  # Remove duplicates
        except:
            # Fallback to hash-based detection
            return self.get_changed_files(repo_path)
    
    def should_use_incremental(self, repo_path: str) -> bool:
        """Check if incremental analysis should be used"""
        return self.hash_file.exists() and len(self._load_hashes()) > 0
    
    def clear_cache(self) -> None:
        """Clear incremental analysis cache"""
        if self.hash_file.exists():
            self.hash_file.unlink()