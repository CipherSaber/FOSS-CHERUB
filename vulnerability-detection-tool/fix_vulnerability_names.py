#!/usr/bin/env python3

import sqlite3
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from foss_scanner import FOSSCHERUBScanner

def fix_vulnerability_names():
    """Fix existing vulnerability names in the database"""
    db_path = "/workspace/vulnerability-detection-tool/foss_cherub.db"
    
    # Initialize scanner for vulnerability naming
    model_path = "/workspace/vulnerability-detection-tool/data_processing/merged_model"
    try:
        scanner = FOSSCHERUBScanner(None, model_path)
    except Exception as e:
        print(f"Could not initialize scanner: {e}")
        print("Using fallback naming...")
        scanner = None
    
    # CWE to vulnerability name mapping
    cwe_to_name = {
        "CWE-79": "Cross-Site Scripting (XSS)",
        "CWE-89": "SQL Injection",
        "CWE-78": "OS Command Injection", 
        "CWE-95": "Code Injection (eval/exec)",
        "CWE-22": "Path Traversal",
        "CWE-120": "Buffer Overflow",
        "CWE-502": "Insecure Deserialization",
        "CWE-798": "Hardcoded Credentials",
        "CWE-327": "Weak Cryptographic Algorithm",
        "CWE-20": "Input Validation Failure",
        "CWE-200": "Information Exposure",
        "CWE-287": "Authentication Bypass",
        "CWE-319": "Cleartext Transmission",
        "CWE-352": "Cross-Site Request Forgery",
        "CWE-434": "Unrestricted File Upload",
        "CWE-601": "Open Redirect",
    }
    
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # Get all findings with "Unknown Vulnerability"
    cursor.execute("""
        SELECT id, cwe_id, description, code_snippet, file_path
        FROM findings 
        WHERE description LIKE '%Unknown%' OR description = '' OR description IS NULL
    """)
    
    findings = cursor.fetchall()
    print(f"Found {len(findings)} findings to fix")
    
    updated = 0
    for finding_id, cwe_id, description, code_snippet, file_path in findings:
        new_name = None
        
        # Try enhanced naming based on code patterns
        if scanner and code_snippet:
            try:
                new_name = scanner.generate_enhanced_vulnerability_name("", code_snippet, cwe_id, "Python")
            except Exception as e:
                print(f"Error generating enhanced name: {e}")
        
        # Fallback to CWE mapping
        if not new_name or "Unknown" in new_name:
            cwe_clean = cwe_id.split(":")[0].strip() if ":" in cwe_id else cwe_id
            new_name = cwe_to_name.get(cwe_clean, f"Security Vulnerability ({cwe_clean})")
        
        # Update the record
        cursor.execute("""
            UPDATE findings 
            SET description = ? 
            WHERE id = ?
        """, (new_name, finding_id))
        
        updated += 1
        print(f"Updated finding {finding_id}: {cwe_id} -> {new_name}")
    
    conn.commit()
    conn.close()
    
    print(f"Successfully updated {updated} vulnerability names")

if __name__ == "__main__":
    fix_vulnerability_names()