#!/usr/bin/env python3

import sqlite3
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from foss_scanner import FOSSCHERUBScanner

def generate_ai_analysis():
    """Generate AI analysis for existing findings"""
    db_path = "/workspace/vulnerability-detection-tool/foss_cherub.db"
    model_path = "/workspace/vulnerability-detection-tool/data_processing/merged_model"
    
    try:
        scanner = FOSSCHERUBScanner(None, model_path)
        print("Scanner initialized successfully")
    except Exception as e:
        print(f"Could not initialize scanner: {e}")
        return
    
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # Get findings without AI analysis
    cursor.execute("""
        SELECT id, cwe_id, description, code_snippet, file_path
        FROM findings 
        WHERE (ai_mitigation IS NULL OR ai_mitigation = '') 
        AND (corrected_code IS NULL OR corrected_code = '')
        LIMIT 10
    """)
    
    findings = cursor.fetchall()
    print(f"Found {len(findings)} findings to analyze")
    
    for finding_id, cwe_id, description, code_snippet, file_path in findings:
        try:
            print(f"Analyzing finding {finding_id}: {description}")
            
            # Generate comprehensive analysis
            analysis = scanner.generate_comprehensive_analysis(
                description, 
                code_snippet, 
                cwe_id, 
                "Python",  # Default language
                "",  # No taint flow for existing findings
                ""   # No AST tree for existing findings
            )
            
            ai_mitigation = analysis.get("ai_mitigation", "Mitigation advice not available")
            corrected_code = analysis.get("corrected_code", "Corrected code not available")
            
            # Update the finding
            cursor.execute("""
                UPDATE findings 
                SET ai_mitigation = ?, corrected_code = ?
                WHERE id = ?
            """, (ai_mitigation, corrected_code, finding_id))
            
            print(f"  ✓ Updated finding {finding_id}")
            
        except Exception as e:
            print(f"  ✗ Error analyzing finding {finding_id}: {e}")
            continue
    
    conn.commit()
    conn.close()
    print("AI analysis generation complete")

if __name__ == "__main__":
    generate_ai_analysis()