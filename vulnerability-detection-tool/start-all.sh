#!/bin/bash

# FOSS-CHERUB Complete Startup Script
# This script starts both the backend API and frontend simultaneously

# Function to cleanup processes
cleanup() {
    echo "\nðŸ›‘ Shutting down all services..."
    if [ ! -z "$BACKEND_PID" ]; then
        kill $BACKEND_PID 2>/dev/null
        echo "âœ“ Backend stopped"
    fi
    if [ ! -z "$FRONTEND_PID" ]; then
        kill $FRONTEND_PID 2>/dev/null
        echo "âœ“ Frontend stopped"
    fi
    # Kill any remaining processes
    pkill -f "python.*api.py" 2>/dev/null
    pkill -f "next dev" 2>/dev/null
    
    # Clear cache on shutdown for clean next startup
    echo "âœ“ Clearing cache for next startup..."
    rm -rf .cache 2>/dev/null || true
    rm -rf .incremental 2>/dev/null || true
    
    echo "âœ“ All services stopped"
    exit 0
}

# Trap signals to cleanup processes
trap cleanup INT TERM EXIT

# Dev container mode - no Docker commands needed
set -e

echo "=========================================="
echo "FOSS-CHERUB Application Startup"
echo "=========================================="
echo ""

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Database setup - SQLite only
echo "[1/5] Database setup..."
echo "Using SQLite database"

# Kill any existing processes
echo "[2/5] Cleaning up existing processes..."
pkill -f "backend.api:app" 2>/dev/null || true
pkill -f "next dev" 2>/dev/null || true
sleep 2

# Clean up caches before startup
echo "[3/5] Clearing application cache..."
rm -rf foss-cherub-ui/.next/dev/lock 2>/dev/null || true
rm -rf .cache 2>/dev/null || true
echo "âœ“ Cache cleared for fresh start"
echo "Note: Incremental analysis cache preserved for faster scans"

# Start Backend API
echo "[4/5] Starting Backend API on port 8082..."
cd "$SCRIPT_DIR/backend" && python api.py > /tmp/backend.log 2>&1 &
BACKEND_PID=$!
echo "Backend PID: $BACKEND_PID"

# Wait for backend to start
sleep 10

# Start Frontend
echo "[5/5] Starting Frontend on port 3002..."
cd "$SCRIPT_DIR/foss-cherub-ui"
PORT=3002 npm run dev > /tmp/frontend.log 2>&1 &
FRONTEND_PID=$!
echo "Frontend PID: $FRONTEND_PID"

echo ""
echo "=========================================="
echo "âœ“ FOSS-CHERUB is running!"
echo "=========================================="
echo ""
echo "Frontend: http://localhost:3002"
echo "Backend:  http://localhost:8082"
echo "Database: SQLite"
echo ""
echo "Backend logs:  tail -f /tmp/backend.log"
echo "Frontend logs: tail -f /tmp/frontend.log"
echo "Database: SQLite files in project directory"
echo ""
echo "ðŸŽ¯ All services are running!"
echo ""
echo "To stop manually:"
echo "  kill $BACKEND_PID $FRONTEND_PID"
echo "  (SQLite database files will persist)"
echo ""
echo "Press Ctrl+C to stop all services automatically"
echo "=========================================="

# Wait for both processes
wait $BACKEND_PID $FRONTEND_PID