// lib/api.ts

// Determine API base URL - works both inside and outside the container
const getApiBase = () => {
  if (typeof window === "undefined") {
    return "http://localhost:8082/api";
  }

  const hostname = window.location.hostname;

  // If accessing from localhost or 127.0.0.1, use localhost:8082
  if (hostname === "localhost" || hostname === "127.0.0.1") {
    return "http://localhost:8082/api";
  }

  // If accessing from a different hostname, construct API URL on same host
  const port = process.env.NEXT_PUBLIC_API_PORT || "8082";
  return `http://${hostname}:${port}/api`;
};

const API_BASE = getApiBase();

// Health check to verify API is reachable
export async function checkApiHealth() {
  try {
    const res = await fetch(`${API_BASE}/health`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      mode: 'cors',
    });
    if (!res.ok) throw new Error(`Health check failed: ${res.status}`);
    return await res.json();
  } catch (error) {
    console.error("API Health Check Failed:", error);
    throw new Error(
      `Cannot reach API at ${API_BASE}. Make sure the backend server is running on port 8082.`
    );
  }
}

export async function createScan(repoUrl: string, name: string) {
  try {
    console.log(`Creating scan for ${repoUrl}...`);
    const res = await fetch(`${API_BASE}/scans`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      mode: 'cors',
      body: JSON.stringify({ repo_url: repoUrl, scan_name: name }),
    });
    if (!res.ok)
      throw new Error(`API returned ${res.status}: ${res.statusText}`);
    return await res.json(); // { scan_id, status, message }
  } catch (error) {
    console.error("Create scan error:", error);
    throw error;
  }
}

export async function uploadScan(file: File) {
  try {
    console.log(`Uploading file: ${file.name}...`);
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch(`${API_BASE}/scans/upload`, {
      method: "POST",
      body: formData,
    });
    if (!res.ok)
      throw new Error(`API returned ${res.status}: ${res.statusText}`);
    return await res.json(); // { scan_id, status, message }
  } catch (error) {
    console.error("Upload scan error:", error);
    throw error;
  }
}

export async function getScan(scanId: string) {
  try {
    const res = await fetch(`${API_BASE}/scans/${scanId}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
      mode: 'cors'
    });
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    return await res.json(); // single scan object
  } catch (error) {
    console.error("Get scan error:", error);
    throw error;
  }
}

export async function getScans() {
  try {
    const res = await fetch(`${API_BASE}/scans`);
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    const data = await res.json(); // { scans: [...] }
    return data.scans ?? [];
  } catch (error) {
    console.error("List scans error:", error);
    throw error;
  }
}

export async function getFindingMitigation(scanId: string, findingId: number) {
  try {
    const res = await fetch(`${API_BASE}/scans/${scanId}/findings/${findingId}/mitigation`);
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    return await res.json();
  } catch (error) {
    console.error("Get mitigation error:", error);
    throw error;
  }
}
