#!/usr/bin/env python3
import psycopg2
import json
from datetime import datetime

# Database connection
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'foss_cherub',
    'user': 'postgres',
    'password': 'foss_cherub_2024'
}

def test_connection():
    """Test basic database connection"""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        cursor.execute("SELECT version();")
        version = cursor.fetchone()
        print(f"✓ Database connected: {version[0]}")
        cursor.close()
        conn.close()
        return True
    except Exception as e:
        print(f"✗ Connection failed: {e}")
        return False

def create_tables():
    """Create necessary tables"""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        
        # Create scans table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS scans (
                id SERIAL PRIMARY KEY,
                scan_id VARCHAR(255) UNIQUE NOT NULL,
                repo_url TEXT,
                scan_name VARCHAR(255),
                status VARCHAR(50) DEFAULT 'running',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP,
                findings_count INTEGER DEFAULT 0
            );
        """)
        
        # Create findings table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS findings (
                id SERIAL PRIMARY KEY,
                scan_id VARCHAR(255) REFERENCES scans(scan_id),
                file_path TEXT,
                line_number INTEGER,
                severity VARCHAR(20),
                cwe_id VARCHAR(20),
                description TEXT,
                code_snippet TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        """)
        
        conn.commit()
        print("✓ Tables created successfully")
        cursor.close()
        conn.close()
        return True
    except Exception as e:
        print(f"✗ Table creation failed: {e}")
        return False

def test_insert_scan():
    """Test inserting a scan record"""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        
        scan_data = {
            'scan_id': 'test-scan-123',
            'repo_url': 'https://github.com/test/repo',
            'scan_name': 'Test Scan',
            'status': 'running'
        }
        
        cursor.execute("""
            INSERT INTO scans (scan_id, repo_url, scan_name, status)
            VALUES (%(scan_id)s, %(repo_url)s, %(scan_name)s, %(status)s)
            ON CONFLICT (scan_id) DO UPDATE SET
            repo_url = EXCLUDED.repo_url,
            scan_name = EXCLUDED.scan_name,
            status = EXCLUDED.status;
        """, scan_data)
        
        conn.commit()
        print("✓ Scan inserted successfully")
        cursor.close()
        conn.close()
        return True
    except Exception as e:
        print(f"✗ Scan insert failed: {e}")
        return False

def test_insert_finding():
    """Test inserting a finding record"""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        
        finding_data = {
            'scan_id': 'test-scan-123',
            'file_path': '/test/file.py',
            'line_number': 42,
            'severity': 'HIGH',
            'cwe_id': 'CWE-89',
            'description': 'SQL Injection vulnerability',
            'code_snippet': 'query = "SELECT * FROM users WHERE id = " + user_id'
        }
        
        cursor.execute("""
            INSERT INTO findings (scan_id, file_path, line_number, severity, cwe_id, description, code_snippet)
            VALUES (%(scan_id)s, %(file_path)s, %(line_number)s, %(severity)s, %(cwe_id)s, %(description)s, %(code_snippet)s);
        """, finding_data)
        
        conn.commit()
        print("✓ Finding inserted successfully")
        cursor.close()
        conn.close()
        return True
    except Exception as e:
        print(f"✗ Finding insert failed: {e}")
        return False

def test_query_data():
    """Test querying data"""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        
        # Query scan with findings
        cursor.execute("""
            SELECT s.scan_id, s.repo_url, s.status, COUNT(f.id) as findings_count
            FROM scans s
            LEFT JOIN findings f ON s.scan_id = f.scan_id
            WHERE s.scan_id = 'test-scan-123'
            GROUP BY s.scan_id, s.repo_url, s.status;
        """)
        
        result = cursor.fetchone()
        if result:
            print(f"✓ Query successful: {result}")
        else:
            print("✗ No data found")
            
        cursor.close()
        conn.close()
        return True
    except Exception as e:
        print(f"✗ Query failed: {e}")
        return False

def cleanup_test_data():
    """Clean up test data"""
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        
        cursor.execute("DELETE FROM findings WHERE scan_id = 'test-scan-123';")
        cursor.execute("DELETE FROM scans WHERE scan_id = 'test-scan-123';")
        
        conn.commit()
        print("✓ Test data cleaned up")
        cursor.close()
        conn.close()
        return True
    except Exception as e:
        print(f"✗ Cleanup failed: {e}")
        return False

if __name__ == "__main__":
    print("=== Database Test Suite ===")
    
    # Run tests
    tests = [
        ("Connection Test", test_connection),
        ("Create Tables", create_tables),
        ("Insert Scan", test_insert_scan),
        ("Insert Finding", test_insert_finding),
        ("Query Data", test_query_data),
        ("Cleanup", cleanup_test_data)
    ]
    
    passed = 0
    for test_name, test_func in tests:
        print(f"\n{test_name}:")
        if test_func():
            passed += 1
    
    print(f"\n=== Results: {passed}/{len(tests)} tests passed ===")