#!/usr/bin/env python3
import requests
import json
import sqlite3
from datetime import datetime
import time

# CVE API endpoints
NVD_API_BASE = "https://services.nvd.nist.gov/rest/json/cves/2.0"
CVE_DB_PATH = "/workspace/vulnerability-detection-tool/cve_database.db"

def init_cve_database():
    """Initialize CVE database with tables"""
    conn = sqlite3.connect(CVE_DB_PATH)
    cursor = conn.cursor()
    
    # CVE table
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS cves (
            id TEXT PRIMARY KEY,
            description TEXT,
            published_date TEXT,
            modified_date TEXT,
            cvss_v3_score REAL,
            cvss_v3_severity TEXT,
            cvss_v2_score REAL,
            cvss_v2_severity TEXT,
            cwe_ids TEXT,
            ref_urls TEXT,
            raw_data TEXT
        );
    """)
    
    # CWE table
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS cwes (
            id TEXT PRIMARY KEY,
            name TEXT,
            description TEXT,
            weakness_type TEXT
        );
    """)
    
    conn.commit()
    conn.close()
    print("✓ CVE database initialized")

def fetch_recent_cves(days=30, max_results=1000):
    """Fetch recent CVEs from NVD API"""
    try:
        # Calculate date range
        end_date = datetime.now()
        start_date = datetime.fromtimestamp(end_date.timestamp() - (days * 24 * 3600))
        
        params = {
            'pubStartDate': start_date.strftime('%Y-%m-%dT%H:%M:%S.000'),
            'pubEndDate': end_date.strftime('%Y-%m-%dT%H:%M:%S.000'),
            'resultsPerPage': min(max_results, 2000)
        }
        
        print(f"Fetching CVEs from {start_date.date()} to {end_date.date()}...")
        response = requests.get(NVD_API_BASE, params=params, timeout=30)
        
        if response.status_code == 200:
            data = response.json()
            cves = data.get('vulnerabilities', [])
            print(f"✓ Fetched {len(cves)} CVEs")
            return cves
        else:
            print(f"✗ API request failed: {response.status_code}")
            return []
            
    except Exception as e:
        print(f"✗ Error fetching CVEs: {e}")
        return []

def parse_cve_data(cve_item):
    """Parse CVE data from NVD format"""
    cve = cve_item.get('cve', {})
    cve_id = cve.get('id', '')
    
    # Description
    descriptions = cve.get('descriptions', [])
    description = next((d['value'] for d in descriptions if d['lang'] == 'en'), '')
    
    # Dates
    published = cve.get('published', '')
    modified = cve.get('lastModified', '')
    
    # CVSS scores
    metrics = cve.get('metrics', {})
    cvss_v3_score = None
    cvss_v3_severity = None
    cvss_v2_score = None
    cvss_v2_severity = None
    
    if 'cvssMetricV31' in metrics and metrics['cvssMetricV31']:
        v3_data = metrics['cvssMetricV31'][0]['cvssData']
        cvss_v3_score = v3_data.get('baseScore')
        cvss_v3_severity = v3_data.get('baseSeverity')
    
    if 'cvssMetricV2' in metrics and metrics['cvssMetricV2']:
        v2_data = metrics['cvssMetricV2'][0]['cvssData']
        cvss_v2_score = v2_data.get('baseScore')
        cvss_v2_severity = v2_data.get('baseSeverity')
    
    # CWE IDs
    weaknesses = cve.get('weaknesses', [])
    cwe_ids = []
    for weakness in weaknesses:
        for desc in weakness.get('description', []):
            if desc.get('lang') == 'en':
                cwe_ids.append(desc.get('value', ''))
    
    # References
    references = [ref.get('url', '') for ref in cve.get('references', [])]
    
    return {
        'id': cve_id,
        'description': description,
        'published_date': published,
        'modified_date': modified,
        'cvss_v3_score': cvss_v3_score,
        'cvss_v3_severity': cvss_v3_severity,
        'cvss_v2_score': cvss_v2_score,
        'cvss_v2_severity': cvss_v2_severity,
        'cwe_ids': ','.join(cwe_ids),
        'references': ','.join(references),
        'raw_data': json.dumps(cve_item)
    }

def insert_cves(cves_data):
    """Insert CVEs into database"""
    conn = sqlite3.connect(CVE_DB_PATH)
    cursor = conn.cursor()
    
    inserted = 0
    for cve_item in cves_data:
        try:
            cve_data = parse_cve_data(cve_item)
            
            cursor.execute("""
                INSERT OR REPLACE INTO cves 
                (id, description, published_date, modified_date, cvss_v3_score, 
                 cvss_v3_severity, cvss_v2_score, cvss_v2_severity, cwe_ids, ref_urls, raw_data)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                cve_data['id'], cve_data['description'], cve_data['published_date'],
                cve_data['modified_date'], cve_data['cvss_v3_score'], cve_data['cvss_v3_severity'],
                cve_data['cvss_v2_score'], cve_data['cvss_v2_severity'], cve_data['cwe_ids'],
                cve_data['references'], cve_data['raw_data']
            ))
            inserted += 1
            
        except Exception as e:
            print(f"✗ Error inserting {cve_item.get('cve', {}).get('id', 'unknown')}: {e}")
    
    conn.commit()
    conn.close()
    print(f"✓ Inserted {inserted} CVEs into database")

def add_common_cwes():
    """Add common CWE definitions"""
    common_cwes = [
        ('CWE-79', 'Cross-site Scripting (XSS)', 'Improper Neutralization of Input During Web Page Generation', 'Base'),
        ('CWE-89', 'SQL Injection', 'Improper Neutralization of Special Elements used in an SQL Command', 'Base'),
        ('CWE-78', 'OS Command Injection', 'Improper Neutralization of Special Elements used in an OS Command', 'Base'),
        ('CWE-22', 'Path Traversal', 'Improper Limitation of a Pathname to a Restricted Directory', 'Base'),
        ('CWE-352', 'Cross-Site Request Forgery (CSRF)', 'Cross-Site Request Forgery (CSRF)', 'Base'),
        ('CWE-434', 'Unrestricted Upload of File with Dangerous Type', 'Unrestricted Upload of File with Dangerous Type', 'Base'),
        ('CWE-502', 'Deserialization of Untrusted Data', 'Deserialization of Untrusted Data', 'Base'),
        ('CWE-287', 'Improper Authentication', 'Improper Authentication', 'Base'),
        ('CWE-798', 'Use of Hard-coded Credentials', 'Use of Hard-coded Credentials', 'Base'),
        ('CWE-200', 'Information Exposure', 'Exposure of Sensitive Information to an Unauthorized Actor', 'Class')
    ]
    
    conn = sqlite3.connect(CVE_DB_PATH)
    cursor = conn.cursor()
    
    for cwe_id, name, description, weakness_type in common_cwes:
        cursor.execute("""
            INSERT OR REPLACE INTO cwes (id, name, description, weakness_type)
            VALUES (?, ?, ?, ?)
        """, (cwe_id, name, description, weakness_type))
    
    conn.commit()
    conn.close()
    print("✓ Added common CWE definitions")

def query_cve_database(cwe_id=None, severity=None, limit=10):
    """Query CVE database"""
    conn = sqlite3.connect(CVE_DB_PATH)
    cursor = conn.cursor()
    
    query = "SELECT id, description, cvss_v3_score, cvss_v3_severity, cwe_ids FROM cves WHERE 1=1"
    params = []
    
    if cwe_id:
        query += " AND cwe_ids LIKE ?"
        params.append(f"%{cwe_id}%")
    
    if severity:
        query += " AND cvss_v3_severity = ?"
        params.append(severity.upper())
    
    query += f" ORDER BY published_date DESC LIMIT {limit}"
    
    cursor.execute(query, params)
    results = cursor.fetchall()
    conn.close()
    
    return results

def test_cve_database():
    """Test CVE database functionality"""
    print("\n=== Testing CVE Database ===")
    
    # Test query
    results = query_cve_database(cwe_id="CWE-89", limit=5)
    print(f"✓ Found {len(results)} SQL injection CVEs")
    
    if results:
        print("Sample CVE:", results[0][0], "-", results[0][1][:100] + "...")
    
    # Count total CVEs
    conn = sqlite3.connect(CVE_DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM cves")
    total = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM cwes")
    cwe_count = cursor.fetchone()[0]
    conn.close()
    
    print(f"✓ Database contains {total} CVEs and {cwe_count} CWEs")

if __name__ == "__main__":
    print("=== CVE Database Setup ===")
    
    # Initialize database
    init_cve_database()
    
    # Add CWE definitions
    add_common_cwes()
    
    # Fetch and import recent CVEs
    print("\nFetching recent CVEs (this may take a moment)...")
    cves = fetch_recent_cves(days=7, max_results=500)  # Last 7 days, max 500 CVEs
    
    if cves:
        insert_cves(cves)
        time.sleep(1)  # Rate limiting
    
    # Test database
    test_cve_database()
    
    print("\n✓ CVE database setup complete!")
    print(f"Database location: {CVE_DB_PATH}")