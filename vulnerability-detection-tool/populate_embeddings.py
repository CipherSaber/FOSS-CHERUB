#!/usr/bin/env python3
"""Populate embeddings for existing findings"""
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent))

from db_connector import CVEDatabase
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def populate_embeddings():
    """Generate and store embeddings for existing findings"""
    try:
        db = CVEDatabase()
        
        # Get all findings without embeddings
        with db.conn.cursor() as cursor:
            cursor.execute("""
                SELECT id, vulnerability_description, cwe_id, severity, 
                       file_path, line_number, ast_analysis
                FROM findings 
                WHERE description_embedding IS NULL OR code_embedding IS NULL
            """)
            findings = cursor.fetchall()
        
        if not findings:
            print("‚úÖ All findings already have embeddings")
            return
        
        print(f"üìä Processing {len(findings)} findings...")
        
        # Process in batches
        batch_size = 100
        for i in range(0, len(findings), batch_size):
            batch = findings[i:i + batch_size]
            print(f"Processing batch {i//batch_size + 1}/{(len(findings) + batch_size - 1)//batch_size}")
            
            for finding in batch:
                finding_id, vuln_desc, cwe_id, severity, file_path, line_num, ast_analysis = finding
                
                # Prepare texts for embedding
                desc_text = db.vector_service.prepare_vulnerability_text({
                    'vulnerability_description': vuln_desc,
                    'cwe_id': cwe_id,
                    'severity': severity,
                    'file_path': file_path
                })
                
                code_text = db.vector_service.prepare_code_text({
                    'ast_analysis': ast_analysis or {},
                    'file_path': file_path,
                    'line_number': line_num
                })
                
                # Generate embeddings
                desc_embedding = db.vector_service.generate_embedding(desc_text)
                code_embedding = db.vector_service.generate_embedding(code_text)
                
                # Update database
                with db.conn.cursor() as cursor:
                    cursor.execute("""
                        UPDATE findings 
                        SET description_embedding = %s, code_embedding = %s
                        WHERE id = %s
                    """, (desc_embedding, code_embedding, finding_id))
        
        print("‚úÖ Embeddings populated successfully!")
        
        # Test similarity search
        print("\nüîç Testing similarity search...")
        results = db.find_similar_vulnerabilities("SQL injection vulnerability", limit=3)
        print(f"Found {len(results)} similar vulnerabilities")
        
        db.close()
        
    except Exception as e:
        logger.error(f"Failed to populate embeddings: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    populate_embeddings()