#!/usr/bin/env python3
"""
Quick verification that enhanced sections are implemented in findings
"""

import tempfile
import os
import json
from foss_scanner import FOSSCHERUBScanner

def test_enhanced_sections():
    """Test that all enhanced sections are generated"""
    
    # Create test file with vulnerability
    test_dir = tempfile.mkdtemp()
    test_file = os.path.join(test_dir, 'vulnerable.py')
    
    with open(test_file, 'w') as f:
        f.write('''
import hashlib
import os

# Hardcoded password (CWE-798)
password = "admin123"

# Weak crypto (CWE-327) 
def hash_password(pwd):
    return hashlib.md5(pwd.encode()).hexdigest()

# Command injection risk (CWE-78)
def run_command(user_input):
    os.system(f"ls {user_input}")

# SQL injection pattern (CWE-89)
def get_user(username):
    query = f"SELECT * FROM users WHERE name='{username}'"
    return query
''')
    
    print("üîç Testing enhanced sections implementation...")
    
    try:
        # Initialize scanner
        model_path = "/workspace/vulnerability-detection-tool/data_processing/merged_model"
        scanner = FOSSCHERUBScanner(None, model_path)
        
        # Run scan
        df = scanner.scan_path(test_dir)
        
        if df.empty:
            print("‚ùå No findings generated")
            return False
            
        print(f"‚úÖ Generated {len(df)} findings")
        
        # Check enhanced sections in first finding
        finding = df.iloc[0].to_dict()
        
        enhanced_sections = [
            'code_quality_improvements',
            'safer_coding_alternatives', 
            'ast_structure_analysis',
            'security_best_practices',
            'performance_impact'
        ]
        
        print("\nüìä Enhanced Sections Status:")
        all_present = True
        
        for section in enhanced_sections:
            if section in finding and finding[section] and finding[section] != f"AI analysis for {section.replace('_', ' ')} unavailable":
                print(f"‚úÖ {section}: IMPLEMENTED")
                print(f"   Preview: {finding[section][:80]}...")
            else:
                print(f"‚ùå {section}: MISSING OR EMPTY")
                all_present = False
        
        # Check additional fields
        additional_fields = [
            'vulnerability_patterns',
            'remediation_priority', 
            'code_complexity_metrics',
            'compliance_violations',
            'business_impact'
        ]
        
        print("\nüìà Additional Fields Status:")
        for field in additional_fields:
            if field in finding and finding[field]:
                if isinstance(finding[field], list):
                    print(f"‚úÖ {field}: {len(finding[field])} items")
                elif isinstance(finding[field], dict):
                    print(f"‚úÖ {field}: {len(finding[field])} metrics")
                else:
                    print(f"‚úÖ {field}: {finding[field]}")
            else:
                print(f"‚ùå {field}: MISSING")
                all_present = False
        
        if all_present:
            print("\nüéâ ALL ENHANCED SECTIONS ARE IMPLEMENTED AND WORKING!")
        else:
            print("\n‚ö†Ô∏è  Some sections are missing or empty")
            
        return all_present
        
    except Exception as e:
        print(f"‚ùå Test failed: {e}")
        return False
    finally:
        # Cleanup
        import shutil
        shutil.rmtree(test_dir, ignore_errors=True)

if __name__ == "__main__":
    test_enhanced_sections()