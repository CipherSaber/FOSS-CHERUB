#!/usr/bin/env python3
"""
Test that enhanced sections are properly passed from backend to frontend
"""

import requests
import json
import tempfile
import os
import time

def test_api_enhanced_sections():
    """Test that API returns enhanced sections"""
    
    # Check if API is running
    try:
        response = requests.get("http://localhost:8082/api/health", timeout=5)
        if response.status_code != 200:
            print("‚ùå API not running. Start with: python backend/api.py")
            return False
    except requests.exceptions.RequestException:
        print("‚ùå API not accessible. Start with: python backend/api.py")
        return False
    
    print("‚úÖ API is running")
    
    # Create test file
    test_code = '''
import hashlib
password = "admin123"  # Hardcoded password
hash_val = hashlib.md5(password.encode()).hexdigest()  # Weak crypto
'''
    
    # Create a temporary file
    with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
        f.write(test_code)
        temp_file = f.name
    
    try:
        # Upload file for scanning
        with open(temp_file, 'rb') as f:
            files = {'file': ('test_vuln.py', f, 'text/plain')}
            response = requests.post("http://localhost:8082/api/scans/upload", files=files)
        
        if response.status_code != 200:
            print(f"‚ùå Upload failed: {response.status_code}")
            return False
        
        scan_data = response.json()
        scan_id = scan_data['scan_id']
        print(f"‚úÖ Scan started: {scan_id}")
        
        # Wait for scan to complete
        print("‚è≥ Waiting for scan to complete...")
        for i in range(30):  # Wait up to 30 seconds
            response = requests.get(f"http://localhost:8082/api/scans/{scan_id}")
            if response.status_code == 200:
                scan_result = response.json()
                if scan_result['status'] == 'completed':
                    break
                elif scan_result['status'] == 'failed':
                    print(f"‚ùå Scan failed: {scan_result.get('error', 'Unknown error')}")
                    return False
            time.sleep(1)
        else:
            print("‚ùå Scan timeout")
            return False
        
        print("‚úÖ Scan completed")
        
        # Check findings
        findings = scan_result.get('findings', [])
        if not findings:
            print("‚ùå No findings generated")
            return False
        
        print(f"‚úÖ Found {len(findings)} findings")
        
        # Check enhanced sections in first finding
        finding = findings[0]
        
        enhanced_sections = [
            'code_quality_improvements',
            'safer_coding_alternatives', 
            'ast_structure_analysis',
            'security_best_practices',
            'performance_impact'
        ]
        
        print("\nüìä Enhanced Sections in API Response:")
        all_present = True
        
        for section in enhanced_sections:
            if section in finding and finding[section]:
                print(f"‚úÖ {section}: PRESENT")
                print(f"   Content: {finding[section][:80]}...")
            else:
                print(f"‚ùå {section}: MISSING")
                all_present = False
        
        # Check additional fields
        additional_fields = [
            'vulnerability_patterns',
            'remediation_priority', 
            'code_complexity_metrics',
            'compliance_violations',
            'business_impact'
        ]
        
        print("\nüìà Additional Fields in API Response:")
        for field in additional_fields:
            if field in finding and finding[field]:
                if isinstance(finding[field], list):
                    print(f"‚úÖ {field}: {len(finding[field])} items")
                elif isinstance(finding[field], dict):
                    print(f"‚úÖ {field}: {len(finding[field])} metrics")
                else:
                    print(f"‚úÖ {field}: {finding[field]}")
            else:
                print(f"‚ùå {field}: MISSING")
                all_present = False
        
        if all_present:
            print("\nüéâ ALL ENHANCED SECTIONS ARE AVAILABLE IN API!")
            print("\nüí° If frontend isn't showing them, check:")
            print("1. Frontend is using the latest API response")
            print("2. TypeScript types are updated")
            print("3. Component is accessing the correct field names")
        else:
            print("\n‚ö†Ô∏è  Some sections are missing from API response")
            
        return all_present
        
    finally:
        # Cleanup
        os.unlink(temp_file)

if __name__ == "__main__":
    test_api_enhanced_sections()